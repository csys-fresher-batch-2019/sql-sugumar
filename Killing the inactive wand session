. /u01/MONITOR/ENV/source_env_scr.sh

maillist=sugumar1220@gmail.com
LOG_FILE=/u01/MONITOR/SCRIPTS/wand_blocking.log export wand_blocking
sqlplus  "/as sysdba" $wand_blocking
set feedback off;
alter session set container=PROD;
set feedback on;
set head off
set feedback off
set pages 0
col module format a20 heading 'module'
col pid format 9999 heading 'PID'
col process format 99999 heading 'Process'
col sid format 99999 heading 'SID'
col serial# format 999999 heading 'SERIAL'
col osuser format a8 heading 'OS|USERNAME'
col username format a10 heading 'ORACLE|USERNAME'
col logon_time format a10 heading 'TIME'
col status format a3 heading 'STAT'
col machine format a10
!rm -f /u01/MONITOR/SCRIPTS/wand_blocking.log
spool /u01/MONITOR/SCRIPTS/wand_blocking.log

SELECT s.module,
       p.spid,
       s.sid,
       s.username,
       s.machine,
       SUBSTR(TO_CHAR(s.logon_time, 'HH24:MI:SS'), 1, 9) AS Time,
       SUBSTR(s.status, 1, 3) AS status,
       s.sql_address AS addr,
       s.last_call_et
FROM v$process p
JOIN v$session s ON s.paddr = p.addr
WHERE s.username IS NOT NULL
AND s.last_call_et > 1100
AND s.status = 'ACTIVE'
AND s.module LIKE 'WANDS%'
--and s.type='BACKGROUND'
ORDER BY s.last_call_et;
spool off

!rm -f /u01/MONITOR/SCRIPTS/activewand.sql

spool /u01/MONITOR/SCRIPTS/activewand.sql

SELECT 'alter system kill session ''' || s.sid || ',' || s.serial# || ''' immediate;'
FROM v$process p
JOIN v$session s ON s.paddr = p.addr
WHERE s.username IS NOT NULL
AND s.last_call_et > 1100
AND s.status = 'ACTIVE'
AND s.module LIKE 'WANDS%'
ORDER BY s.last_call_et;
/
spool off
@/u01/activewand.sql
exit
EOF

echo "WANDS_Report_blocking_oacore" | mail -s "WANDS_Report_blocking_oacore" -a "$wand_blocking" "sugumar1220@gmail.com"




